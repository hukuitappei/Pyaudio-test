# Googleカレンダートークンエラー解決ガイド

## エラーの概要

Googleカレンダーの接続テストで以下のエラーが発生した場合の解決方法を説明します：

```
カレンダー接続テストに失敗: ('invalid_grant: Token has been expired or revoked.', {'error': 'invalid_grant', 'error_description': 'Token has been expired or revoked.'})
```

## エラーの原因

このエラーは以下の理由で発生します：

1. **リフレッシュトークンの期限切れ**: リフレッシュトークンが一定期間使用されていない
2. **トークンの無効化**: Googleアカウントのセキュリティ設定変更
3. **アプリケーションの権限取り消し**: Googleアカウントでアプリケーションの権限が取り消された
4. **認証情報の変更**: Google Cloud Consoleでの設定変更

## 解決方法

### 方法1: 認証情報の自動更新（推奨）

1. **カレンダー管理タブ**に移動
2. **「🔄 認証情報を更新」**ボタンをクリック
3. 更新が成功した場合は完了メッセージが表示されます
4. 失敗した場合は方法2を実行してください

### 方法2: 認証フローのリセット

1. **カレンダー管理タブ**に移動
2. **「🔄 認証フローをリセット」**ボタンをクリック
3. **「🔐 Googleカレンダー認証」**ボタンをクリック
4. 認証URLをクリックしてGoogle認証画面を開く
5. Googleアカウントでログインし、権限を許可
6. 表示された認証コードを入力
7. 新しいリフレッシュトークンを取得
8. Streamlit Secretsに新しいリフレッシュトークンを設定

### 方法3: 手動での認証情報更新

#### 手順1: Streamlit Secretsの更新

1. Streamlit Cloudのダッシュボードにアクセス
2. 該当アプリの設定画面を開く
3. **Secrets**タブを選択
4. 以下の形式で認証情報を更新：

```toml
OPENAI_API_KEY = "your_openai_api_key"
GOOGLE_CLIENT_ID = "your_google_client_id.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET = "GOCSPX-your_google_client_secret"
GOOGLE_REFRESH_TOKEN = "your_new_refresh_token"
```

#### 手順2: 新しいリフレッシュトークンの取得

1. **Google Cloud Console**にアクセス
2. 該当プロジェクトを選択
3. **APIとサービス** → **認証情報**を開く
4. OAuth 2.0クライアントIDを確認
5. 必要に応じて新しいクライアントIDを作成

## 予防策

### 1. 定期的な認証確認

- 月に1回程度、カレンダー接続テストを実行
- エラーが発生した場合は早期に対応

### 2. 認証情報の管理

- リフレッシュトークンは安全に保管
- 定期的に認証情報を更新
- 不要なアプリケーションの権限は取り消し

### 3. Googleアカウントのセキュリティ

- 2段階認証を有効化
- セキュリティ設定の変更時は注意
- アプリパスワードの使用を検討

## トラブルシューティング

### 認証情報更新が失敗する場合

1. **ネットワーク接続**を確認
2. **Google Cloud Console**でプロジェクトが有効か確認
3. **OAuth同意画面**の設定を確認
4. **リダイレクトURI**の設定を確認

### 新しいリフレッシュトークンが取得できない場合

1. **Googleアカウント**のセキュリティ設定を確認
2. **アプリケーションの権限**が取り消されていないか確認
3. **Google Cloud Console**でOAuth 2.0クライアントIDが有効か確認
4. **スコープ**の設定を確認

### Streamlit Secretsの更新が反映されない場合

1. **アプリケーションを再起動**
2. **ブラウザのキャッシュをクリア**
3. **Streamlit Cloud**の設定を再確認
4. **環境変数**の設定を確認

## よくある質問

### Q: リフレッシュトークンはどのくらいの期間有効ですか？

A: リフレッシュトークンは通常6ヶ月間有効ですが、使用状況やセキュリティ設定によって変動します。

### Q: 認証情報を更新してもエラーが続く場合は？

A: Google Cloud ConsoleでOAuth 2.0クライアントIDを再作成し、新しい認証情報を取得してください。

### Q: 複数のアプリケーションで同じ認証情報を使用できますか？

A: はい、同じGoogle Cloud Consoleプロジェクトの認証情報を複数のアプリケーションで使用できます。

### Q: セキュリティ上の注意点は？

A: 認証情報は絶対に公開リポジトリにコミットしないでください。Streamlit Secretsまたは環境変数で安全に管理してください。

## 関連ドキュメント

- [Googleカレンダー連携設定ガイド](./Googleカレンダー連携設定ガイド.md)
- [Streamlit Secrets設定ガイド](./StreamlitSecrets設定ガイド.md)
- [Google認証設定ガイド](./Google認証設定ガイド.md)
