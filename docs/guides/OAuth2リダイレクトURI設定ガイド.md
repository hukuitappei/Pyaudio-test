# OAuth 2.0リダイレクトURI設定ガイド

## エラー内容
```
無効なドメイン: スキーム（http:// または https://）を指定することはできません
```

## 原因
Google Cloud ConsoleのOAuth 2.0設定で、Streamlit CloudのURLをリダイレクトURIとして設定しようとしているため。

## 解決方法

### ステップ1: Google Cloud Consoleにアクセス
1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. プロジェクトを選択
3. 「APIとサービス」→「認証情報」を選択

### ステップ2: OAuth 2.0クライアントIDを編集
1. OAuth 2.0クライアントIDをクリック
2. 「承認済みのリダイレクトURI」セクションを編集

### ステップ3: 正しいリダイレクトURIを設定
**削除するURI（間違った設定）:**
```
https://pyaudio-test-8fnqhyhtvx8vlgz2mzkocy.streamlit.app/
```

**追加するURI（正しい設定）:**
```
urn:ietf:wg:oauth:2.0:oob
```

### ステップ4: 設定を保存
1. 「+ URIを追加」をクリック
2. `urn:ietf:wg:oauth:2.0:oob`を入力
3. 「保存」をクリック

## なぜこの設定が必要か

### Out-of-Band認証
- **`urn:ietf:wg:oauth:2.0:oob`**: 標準的なOut-of-Band認証用URI
- **用途**: ブラウザベースのリダイレクトが制限されている環境
- **動作**: 認証完了後、Googleが認証コードを直接表示

### Streamlit Cloud環境の制限
- **ブラウザリダイレクト**: Streamlit Cloudでは制限されている
- **手動認証**: 認証コードを手動で入力する方式が必要
- **セキュリティ**: より安全な認証方式

## 設定完了後の手順

### 1. アプリケーションでの認証
1. カレンダー管理タブに移動
2. 「🔄 認証フローをリセット」をクリック
3. 「🔄 ページを再読み込み」をクリック
4. 「🔑 Google認証を開始」をクリック
5. 「方法2: Streamlit Cloud用認証フロー」を選択

### 2. 認証手順
1. 認証URLをクリック
2. Google認証画面でアプリケーションを承認
3. 認証コードをコピー
4. アプリケーションの入力欄に貼り付け
5. 「認証を完了」をクリック

### 3. リフレッシュトークンの設定
1. 認証完了後、新しいリフレッシュトークンが表示される
2. Streamlit Cloud Secretsに設定
3. 接続テストを実行

## トラブルシューティング

### 問題1: まだエラーが発生する
**原因**: キャッシュされた設定
**解決方法**:
- ブラウザのキャッシュをクリア
- Google Cloud Consoleで設定を再確認
- 数分待ってから再試行

### 問題2: 認証コードが表示されない
**原因**: 認証が完全に完了していない
**解決方法**:
- 認証手順を最初から再実行
- 別のブラウザで試行
- プライベートブラウジングモードで試行

### 問題3: 認証コードが無効
**原因**: 認証コードの有効期限切れ
**解決方法**:
- 新しい認証URLを生成
- 認証を再実行
- 認証コードを正確にコピー&ペースト

## 重要な注意事項

1. **URIの正確性**: `urn:ietf:wg:oauth:2.0:oob`を正確に入力
2. **設定の保存**: Google Cloud Consoleで必ず保存を実行
3. **認証コードの管理**: 認証コードは機密情報として扱う
4. **リフレッシュトークン**: 取得後は安全に保存

## 関連ファイル
- `src/utils_audiorec.py`: 認証管理機能
- `.streamlit/secrets.toml`: 認証情報設定

## 更新日時
2025年1月現在
