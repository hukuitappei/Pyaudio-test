# Webアプリケーション用Google認証セキュリティ設定ガイド

## 概要
WebアプリケーションでGoogleカレンダー機能を使用する際のセキュリティ設定について説明します。

## 問題点
- `credentials.json`ファイルをWebアプリケーションに直接配置するとセキュリティリスクがあります
- デスクトップアプリケーション用のOAuth2.0フローはWebアプリケーションに適していません
- 認証情報の漏洩リスクがあります

## 推奨される解決策

### 1. 環境変数による認証情報管理（推奨）

#### 設定手順
1. **Google Cloud Consoleで認証情報を作成**
   ```
   Google Cloud Console → APIs & Services → Credentials
   → Create Credentials → OAuth 2.0 Client IDs
   ```

2. **環境変数を設定**
   ```bash
   # Windows PowerShell
   $env:GOOGLE_CLIENT_ID="your_client_id"
   $env:GOOGLE_CLIENT_SECRET="your_client_secret"
   $env:GOOGLE_REFRESH_TOKEN="your_refresh_token"
   
   # または .env ファイルを使用
   ```

3. **初回認証でリフレッシュトークンを取得**
   - 開発時のみ`credentials.json`を使用
   - 認証後にリフレッシュトークンを取得
   - 環境変数に設定

#### メリット
- ✅ 認証情報がコードに含まれない
- ✅ 環境ごとに異なる設定が可能
- ✅ セキュリティリスクが低い
- ✅ 本番環境に適している

### 2. ファイル認証（開発用のみ）

#### 使用場面
- ローカル開発時
- テスト環境
- 個人使用

#### 注意事項
- ❌ 本番環境では使用しない
- ❌ 認証情報をGitにコミットしない
- ✅ `.gitignore`に`credentials.json`を追加

## セキュリティベストプラクティス

### 1. ファイル管理
```gitignore
# .gitignore に追加
credentials.json
token.pickle
.env
*.key
```

### 2. 環境変数管理
```bash
# 本番環境での設定例
export GOOGLE_CLIENT_ID="your_production_client_id"
export GOOGLE_CLIENT_SECRET="your_production_client_secret"
export GOOGLE_REFRESH_TOKEN="your_production_refresh_token"
```

### 3. アクセス制御
- 必要最小限のスコープのみを設定
- 定期的に認証情報を更新
- アクセスログを監視

## 設定確認方法

### アプリケーション内での確認
1. Streamlitアプリケーションを起動
2. 設定画面で認証状態を確認
3. 環境変数の設定状況を確認

### コマンドラインでの確認
```bash
# 環境変数の確認
echo $GOOGLE_CLIENT_ID
echo $GOOGLE_CLIENT_SECRET

# 認証テスト
python -c "from utils_audiorec import GoogleCalendarManager; gc = GoogleCalendarManager(); print(gc.authenticate())"
```

## トラブルシューティング

### よくある問題
1. **認証エラー**: 環境変数が正しく設定されているか確認
2. **スコープエラー**: 必要な権限が付与されているか確認
3. **トークン期限切れ**: リフレッシュトークンを更新

### デバッグ方法
```python
# 認証状態の確認
gc = GoogleCalendarManager()
status = gc.get_authentication_status()
print(f"認証状態: {status}")
```

## 本番環境での注意事項

1. **HTTPS必須**: 本番環境では必ずHTTPSを使用
2. **環境変数管理**: シークレット管理サービスを使用
3. **アクセス制限**: IPアドレス制限や認証を追加
4. **ログ監視**: アクセスログを監視・記録
5. **定期更新**: 認証情報を定期的に更新

## 参考リンク
- [Google Cloud Console](https://console.cloud.google.com/)
- [Google Calendar API Documentation](https://developers.google.com/calendar/api)
- [OAuth 2.0 for Web Applications](https://developers.google.com/identity/protocols/oauth2/web) 