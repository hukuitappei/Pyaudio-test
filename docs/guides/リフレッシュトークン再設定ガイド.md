# リフレッシュトークン再設定ガイド

## 概要
Google認証のリフレッシュトークンが無効になった場合の再設定手順を説明します。

## 前提条件
- Google Cloud ConsoleでOAuth 2.0クライアントIDが設定済み
- `GOOGLE_CLIENT_ID`と`GOOGLE_CLIENT_SECRET`がStreamlit Secretsに設定済み

## 再設定手順

### ステップ1: 認証状態のクリア
1. アプリケーションのカレンダー管理タブに移動
2. 「🔄 認証フローをリセット」ボタンをクリック
3. 「🔄 ページを再読み込み」ボタンをクリック

### ステップ2: 新しい認証の実行
1. 「🔑 Google認証を開始」ボタンをクリック
2. 表示された認証URLをクリック
3. Google認証画面で以下を実行：
   - アカウントを選択
   - アプリケーションの権限を承認
4. 認証コードをコピー
5. アプリケーションの認証コード入力欄に貼り付け
6. 「認証を完了」ボタンをクリック

### ステップ3: 新しいリフレッシュトークンの取得
認証が完了すると、以下の情報が表示されます：

```
✅ Google Calendar認証が完了しました

📝 Streamlit Secrets設定情報:
以下の内容を.streamlit/secrets.tomlに追加してください：

# Google認証情報
GOOGLE_CLIENT_ID = "your-client-id"
GOOGLE_CLIENT_SECRET = "your-client-secret"
GOOGLE_REFRESH_TOKEN = "your-new-refresh-token"
```

### ステップ4: Streamlit Secretsの更新
1. Streamlit Cloudの管理画面に移動
2. 「Settings」→「Secrets」を選択
3. 既存の`GOOGLE_REFRESH_TOKEN`を新しい値で更新
4. 「Save」をクリック

### ステップ5: 接続テストの実行
1. アプリケーションに戻る
2. 「🔍 接続テスト」を実行
3. 成功メッセージが表示されることを確認

## トラブルシューティング

### 問題1: 認証URLが表示されない
**原因**: 認証フローが正しく初期化されていない
**解決方法**:
- ページを再読み込み
- 認証フローをリセットして再試行

### 問題2: 認証コードが無効
**原因**: 認証コードの有効期限切れまたは不正な値
**解決方法**:
- 認証URLを再生成
- 新しい認証コードを取得

### 問題3: リフレッシュトークンが表示されない
**原因**: 認証が完全に完了していない
**解決方法**:
- 認証手順を最初から再実行
- ブラウザのキャッシュをクリア

### 問題4: 接続テストが失敗する
**原因**: 新しいリフレッシュトークンが正しく設定されていない
**解決方法**:
- Streamlit Secretsの設定を再確認
- アプリケーションを再起動

## 予防策

### 定期的な認証状態確認
- 週1回程度、カレンダー同期機能をテスト
- 認証エラーが発生した場合は早期に対応

### 認証情報のバックアップ
- 有効な認証情報を安全な場所に保存
- 認証情報の変更時は即座に更新

## 重要な注意事項

1. **セキュリティ**: リフレッシュトークンは機密情報です。適切に管理してください
2. **有効期限**: リフレッシュトークンには有効期限があります
3. **権限**: 必要な権限（Google Calendar API）が有効になっていることを確認してください

## 関連ファイル
- `src/utils_audiorec.py`: 認証管理機能
- `src/settings_ui_audiorec.py`: 認証UI
- `config/config_manager.py`: 設定管理

## 更新日時
2025年1月現在
