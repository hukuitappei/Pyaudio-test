# 認証コード処理エラー解決ガイド

## 問題の概要
Streamlit Cloud上で認証コードを入力した後に「認証に失敗しました」エラーが発生する問題の解決方法を説明します。

## よくある原因と対処法

### 1. 認証コードの形式エラー
**症状**: 認証コード入力後に即座にエラーが発生
**原因**: 認証コードの前後に空白が含まれている、または不完全なコード
**対処法**:
- 認証コードを正確にコピー&ペースト
- 前後の空白を削除
- 認証コードは一度しか使用できないため、新しいコードを取得

### 2. リダイレクトURI不一致エラー
**症状**: `redirect_uri_mismatch` エラー
**原因**: Google Cloud Consoleの設定とアプリケーションの設定が一致しない
**対処法**:
1. Google Cloud Consoleにアクセス
2. 「承認済みのリダイレクトURI」を確認
3. `urn:ietf:wg:oauth:2.0:oob` が設定されていることを確認
4. Streamlit CloudのURLが設定されていないことを確認

### 3. クライアント認証情報エラー
**症状**: `invalid_client` エラー
**原因**: Client IDまたはClient Secretが無効
**対処法**:
1. Streamlit Secretsの設定を確認
2. Google Cloud Consoleで新しいクライアント認証情報を生成
3. 新しい認証情報をStreamlit Secretsに設定

### 4. 認証コード期限切れエラー
**症状**: `invalid_grant` エラー
**原因**: 認証コードの有効期限（通常10分）が過ぎている
**対処法**:
1. 認証フローをリセット
2. 新しい認証URLを生成
3. 新しい認証コードを取得

## 修正された認証フロー

### 改善点
1. **詳細なエラーメッセージ**: 具体的なエラー原因を表示
2. **認証コード検証**: 入力値の形式チェック
3. **段階的な処理**: 各ステップでの状態確認
4. **対処法の提示**: エラーに応じた具体的な解決手順

### 認証手順
1. **認証フロー初期化**
   - 認証情報の確認
   - 認証URLの生成
   - セッション状態の管理

2. **認証コード取得**
   - Google認証画面で認証
   - 認証コードをコピー

3. **認証コード処理**
   - 入力値の検証
   - トークンの取得
   - リフレッシュトークンの表示

## トラブルシューティング手順

### ステップ1: 認証フローのリセット
```
1. 「🔄 認証フローをリセット」ボタンをクリック
2. ページを再読み込み
3. 新しい認証を開始
```

### ステップ2: Google Cloud Console設定の確認
```
1. https://console.cloud.google.com/ にアクセス
2. プロジェクト「voice-memo-app-467900」を選択
3. 「APIs & Services」→「認証情報」を選択
4. OAuth 2.0クライアントIDを確認
5. 「承認済みのリダイレクトURI」を確認
   - ✅ urn:ietf:wg:oauth:2.0:oob
   - ❌ Streamlit CloudのURL（削除）
```

### ステップ3: Streamlit Secrets設定の確認
```
1. Streamlit Cloudの管理画面にアクセス
2. 「Settings」→「Secrets」を選択
3. 以下の設定を確認:
   - GOOGLE_CLIENT_ID
   - GOOGLE_CLIENT_SECRET
   - GOOGLE_REFRESH_TOKEN（初回認証後）
```

### ステップ4: 認証の再実行
```
1. 認証フローをリセット
2. 新しい認証URLを生成
3. Google認証画面で認証
4. 新しい認証コードを取得
5. 認証コードを入力して認証完了
```

## エラーメッセージ別対処法

### `invalid_grant`
- 認証コードが無効または期限切れ
- 新しい認証コードを取得

### `redirect_uri_mismatch`
- リダイレクトURIが一致しない
- Google Cloud Consoleの設定を確認

### `invalid_client`
- クライアント認証情報が無効
- Streamlit Secretsの設定を確認

### `access_denied`
- ユーザーが認証を拒否
- 認証画面で「許可」をクリック

## 成功の確認

認証が成功すると以下が表示されます：
- ✅ 認証が完了しました！
- 🔑 リフレッシュトークンが表示される
- 📝 設定手順が表示される

## 次のステップ

1. 表示されたリフレッシュトークンをコピー
2. Streamlit CloudのSecrets設定でGOOGLE_REFRESH_TOKENに設定
3. アプリケーションを再起動
4. カレンダー同期機能をテスト

## 注意事項

- 認証コードは一度しか使用できません
- 認証コードの有効期限は約10分です
- リフレッシュトークンは機密情報です
- 認証フローは定期的にリセットが必要な場合があります

このガイドに従って設定を完了すれば、Google Calendar認証が正常に動作するようになります。
